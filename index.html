<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>US Peaks Explorer</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>

  <style>
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    #panel {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 280px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      z-index: 99;
    }

    #panel h3 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 16px;
    }

    .section {
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #555;
    }

    select, input, button {
      width: 100%;
      padding: 6px;
      margin-top: 6px;
      border-radius: 6px;
      font-size: 13px;
    }

    select, input {
      border: 1px solid #ccc;
    }

    button {
      border: none;
      background: #0079c1;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #005e95;
    }

    .secondary {
      background: #666;
    }

    .secondary:hover {
      background: #444;
    }
  </style>
</head>

<body>
  <div id="viewDiv"></div>

  <!-- CONTROL PANEL -->
  <div id="panel">
    <h3>US Peaks Explorer</h3>

    <div class="section">
      <div class="section-title">Filter by Elevation (ft)</div>

      <select id="elevationSelect">
        <option value="">-- Select Elevation --</option>
        <option value="1000">Below 1,000 ft</option>
        <option value="5000">Below 5,000 ft</option>
        <option value="10000">Below 10,000 ft</option>
        <option value="15000">Below 15,000 ft</option>
        <option value="custom">Custom Value</option>
      </select>

      <input
        type="number"
        id="customElevation"
        placeholder="Enter elevation (ft)"
        style="display:none;"
      />

      <button id="applyFilter">Apply Filter</button>
      <button id="clearFilter" class="secondary">Show All</button>
    </div>

    <div class="section">
      <button id="toggleRenderer" class="secondary">
        Toggle Elevation / State
      </button>
    </div>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
       "esri/rest/support/Query"
    ], function (Map, MapView, FeatureLayer, Legend,Query) {

      // MAP
      const map = new Map({
        basemap: "topo-vector"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-110, 40],
        zoom: 4
      });

      /* -----------------------------------
         ELEVATION-BASED RENDERER
      ----------------------------------- */
      const elevationRenderer = {
        type: "class-breaks",
        field: "ELEV_ft",
        legendOptions: { title: "Peak Elevation (ft)" },
        classBreakInfos: [
          {
            minValue: 0,
            maxValue: 10000,
            label: "Below 10,000 ft",
            symbol: {
              type: "simple-marker",
              size: 6,
              color: "#74add1",
              outline: { color: "#333", width: 0.5 }
            }
          },
          {
            minValue: 10000,
            maxValue: 30000,
            label: "Above 10,000 ft",
            symbol: {
              type: "simple-marker",
              size: 14,
              color: "#d73027",
              outline: { color: "#333", width: 0.5 }
            }
          }
        ]
      };

      /* -----------------------------------
         STATE-BASED RENDERER
      ----------------------------------- */
      let stateRenderer = {
        type: "unique-value",
        field: "STATE",
        legendOptions: { title: "Peaks by State" },
        defaultSymbol: {
          type: "simple-marker",
          size: 8,
          color: "#cccccc",
          outline: { color: "#444", width: 0.5 }
        }
      };

      /* -----------------------------------
         FEATURE LAYER
      ----------------------------------- */
      const peaksLayer = new FeatureLayer({
        url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/Prominent_Peaks_US/FeatureServer/0",

        renderer: elevationRenderer,
        outFields: ["*"],

        // PERFORMANCE OPTIMIZATION
      
        maxScale: 50000,

        featureReduction: {
          type: "selection"
        },

        popupTemplate: {
          title: "{MTN_PEAK}",
          content: `
            <table style="width:100%; border-collapse:collapse; font-size:13px; border:1px solid #dcdcdc;">
              <tr style="background:#f3f3f3;">
                <th style="padding:8px; border-right:1px solid #dcdcdc;">Peak Name</th>
                <td style="padding:8px;">{MTN_PEAK}</td>
              </tr>
              <tr>
                <th style="padding:8px; border-right:1px solid #dcdcdc;">State</th>
                <td style="padding:8px;">{STATE}</td>
              </tr>
              <tr style="background:#f9f9f9;">
                <th style="padding:8px; border-right:1px solid #dcdcdc;">Elevation (ft)</th>
                <td style="padding:8px;">{ELEV_ft}</td>
              </tr>
              <tr>
                <th style="padding:8px; border-right:1px solid #dcdcdc;">Elevation (m)</th>
                <td style="padding:8px;">{ELEV_m}</td>
              </tr>
            </table>
          `
        },

        // LABELS FOR HIGH PEAKS
        labelingInfo: [{
          where: "ELEV_ft > 15000",
          labelExpressionInfo: {
            expression: "$feature.MTN_PEAK"
          },
          symbol: {
            type: "text",
            color: "#b30000",
            haloColor: "white",
            haloSize: 1,
            font: {
              size: 12,
              weight: "bold"
            }
          }
        }]
      });

      view.map.add(peaksLayer);
      const heatmapRenderer = {
  type: "heatmap",
  field: "ELEV_ft",
  blurRadius: 12,
  maxPixelIntensity: 200,
  minPixelIntensity: 0
};
view.watch("scale", scale => {
  peaksLayer.renderer = scale > 15000000 ? heatmapRenderer : elevationRenderer;
});
      // LEGEND
      const legend = new Legend({ view });
      view.ui.add(legend, "bottom-right");

      /* -----------------------------------
         FILTER LOGIC
      ----------------------------------- */
      let layerView;
      view.whenLayerView(peaksLayer).then(lv => layerView = lv);

      const select = document.getElementById("elevationSelect");
      const customInput = document.getElementById("customElevation");

      select.onchange = () => {
        customInput.style.display = select.value === "custom" ? "block" : "none";
      };

      document.getElementById("applyFilter").onclick = () => {
        if (!layerView) return;

        const maxVal = select.value === "custom"
          ? Number(customInput.value)
          : Number(select.value);

        if (!maxVal) return;

        layerView.filter = {
          where: `ELEV_ft <= ${maxVal}`
        };
      };

      document.getElementById("clearFilter").onclick = () => {
        layerView.filter = null;
        select.value = "";
        customInput.value = "";
        customInput.style.display = "none";
      };

      /* -----------------------------------
         RENDERER TOGGLE
      ----------------------------------- */
     let elevationMode = true; 

// Prepare stateRenderer once
peaksLayer.load().then(() => {
    // Create a proper query
    const query = peaksLayer.createQuery();
    query.returnDistinctValues = true;
    query.outFields = ["STATE"];

    peaksLayer.queryFeatures(query).then(results => {
      // Get unique states
      const states = [...new Set(results.features.map(f => f.attributes.STATE).filter(s => s))];

      // Build uniqueValueInfos
      const uniqueValueInfos = states.map((state, i) => {
        const hue = (i * 360 / states.length) % 360;
        const color = `hsl(${hue}, 70%, 50%)`;
        return {
          value: state,
          symbol: {
            type: "simple-marker",
            color: color,
            size: 10,
            outline: { color: "#333", width: 0.5 }
          },
          label: state
        };
      });

      // Prepare state renderer
      stateRenderer = {
        type: "unique-value",
        field: "STATE",
        uniqueValueInfos: uniqueValueInfos,
        defaultSymbol: { type: "simple-marker", size: 10, color: "#999" }
      };

      console.log("State renderer ready:", stateRenderer);
    });
  });

// Toggle renderer on button click
document.getElementById("toggleRenderer").onclick = () => {
  if (!stateRenderer) {
    alert("Please wait, preparing state renderer...");
    return;
  }

  peaksLayer.renderer = elevationMode ? stateRenderer : elevationRenderer;
  elevationMode = !elevationMode;
};


    });
  </script>
</body>
</html>
